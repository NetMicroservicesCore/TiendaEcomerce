<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Roles</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jTable CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jtable/2.4.0/themes/lightcolor/blue/jtable.min.css" rel="stylesheet">
    <link href="~/css/test.css" rel="stylesheet" />
    
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-shield-lock-fill"></i> Administración de Roles</h1>
                    <p class="mb-0 opacity-75">Gestiona los roles y permisos del sistema</p>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-light" onclick="toggleCreatePanel()">
                        <i class="bi bi-plus-circle-fill"></i> Nuevo Rol
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Panel de Creación -->
        <div class="create-panel animate-slide" id="createPanel" style="display: none;">
            <h4 class="mb-4"><i class="bi bi-plus-square"></i> Crear Nuevo Rol</h4>
            <form id="createRoleForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="roleName" class="form-label fw-semibold">
                            Nombre del Rol <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="roleName" name="Name"
                               required minlength="3" maxlength="50" placeholder="Ej. Administrador">
                        <div class="invalid-feedback">
                            El nombre del rol es requerido (mínimo 3 caracteres).
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="roleDescription" class="form-label fw-semibold">Descripción</label>
                        <input type="text" class="form-control" id="roleDescription" name="Description"
                               maxlength="200" placeholder="Describe brevemente la función del rol">
                    </div>

                    <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="roleActive" name="IsActive" checked>
                            <label class="form-check-label fw-semibold" for="roleActive">
                                Rol Activo
                            </label>
                        </div>
                    </div>

                    <div class="col-12 text-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" onclick="toggleCreatePanel()">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Rol
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- jTable Container -->
        <div class="main-card">
            <div id="RolesTableContainer"></div>
        </div>
    </div>

    <!-- Modal de Edición -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Rol</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="editRoleForm">
                    <div class="modal-body">
                        <input type="hidden" id="editRoleId" name="Id">

                        <div class="mb-3">
                            <label for="editRoleName" class="form-label fw-semibold">
                                Nombre del Rol <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="editRoleName" name="Name"
                                   required minlength="3" maxlength="50">
                        </div>

                        <div class="mb-3">
                            <label for="editRoleDescription" class="form-label fw-semibold">Descripción</label>
                            <textarea class="form-control" id="editRoleDescription" name="Description"
                                      rows="3" maxlength="200"></textarea>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editRoleActive" name="IsActive">
                            <label class="form-check-label fw-semibold" for="editRoleActive">
                                Rol Activo
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Eliminación -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro que deseas eliminar el rol <strong id="deleteRoleName"></strong>?</p>
                    <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
                    <input type="hidden" id="deleteRoleId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteRole()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jtable/2.4.0/jquery.jtable.min.js"></script>

    <script>
        // Datos de ejemplo (reemplazar con llamadas al servidor)
        let rolesData = [
            { Id: '1', Name: 'Administrador', Description: 'Control total del sistema', IsActive: true, CreatedDate: '2025-01-15' },
            { Id: '2', Name: 'Editor', Description: 'Puede crear y editar contenido', IsActive: true, CreatedDate: '2025-02-20' },
            { Id: '3', Name: 'Visualizador', Description: 'Solo puede ver información', IsActive: false, CreatedDate: '2025-03-10' },
            { Id: '4', Name: 'Supervisor', Description: 'Supervisa operaciones diarias', IsActive: true, CreatedDate: '2025-04-05' }
        ];

        // Inicializar jTable
        $(document).ready(function() {
            $('#RolesTableContainer').jtable({
                title: 'Roles del Sistema',
                paging: true,
                pageSize: 10,
                sorting: true,
                defaultSorting: 'Name ASC',
                actions: {
                    listAction: function(postData, jtParams) {
                        return new Promise((resolve) => {
                            // Simulación de búsqueda y ordenamiento
                            let filteredData = [...rolesData];

                            // Ordenamiento
                            if (jtParams.jtSorting) {
                                const [field, order] = jtParams.jtSorting.split(' ');
                                filteredData.sort((a, b) => {
                                    if (order === 'ASC') {
                                        return a[field] > b[field] ? 1 : -1;
                                    } else {
                                        return a[field] < b[field] ? 1 : -1;
                                    }
                                });
                            }

                            // Paginación
                            const startIndex = jtParams.jtStartIndex;
                            const pageSize = jtParams.jtPageSize;
                            const pagedData = filteredData.slice(startIndex, startIndex + pageSize);

                            resolve({
                                Result: 'OK',
                                Records: pagedData,
                                TotalRecordCount: filteredData.length
                            });
                        });
                    }
                },
                fields: {
                    Id: {
                        key: true,
                        list: false
                    },
                    Name: {
                        title: 'Nombre',
                        width: '25%'
                    },
                    Description: {
                        title: 'Descripción',
                        width: '35%',
                        display: function(data) {
                            return data.record.Description || '<span class="text-muted">-</span>';
                        }
                    },
                    IsActive: {
                        title: 'Estado',
                        width: '15%',
                        display: function(data) {
                            const isActive = data.record.IsActive;
                            const badgeClass = isActive ? 'bg-success' : 'bg-secondary';
                            const text = isActive ? 'Activo' : 'Inactivo';
                            return `<span class="badge ${badgeClass}">${text}</span>`;
                        }
                    },
                    CreatedDate: {
                        title: 'Fecha Creación',
                        width: '15%',
                        display: function(data) {
                            const date = new Date(data.record.CreatedDate);
                            return date.toLocaleDateString('es-MX');
                        }
                    },
                    Actions: {
                        title: 'Acciones',
                        width: '10%',
                        sorting: false,
                        display: function(data) {
                            return `
                                <div class="action-buttons">
                                    <button class="btn-edit" onclick="openEditModal('${data.record.Id}')" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn-delete" onclick="openDeleteModal('${data.record.Id}')" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                }
            });

            // Cargar datos
            $('#RolesTableContainer').jtable('load');
        });

        // Toggle panel de creación
        function toggleCreatePanel() {
            const panel = document.getElementById('createPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                document.getElementById('createRoleForm').reset();
            } else {
                panel.style.display = 'none';
            }
        }

        // Crear rol
        document.getElementById('createRoleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const formData = {
                Id: (rolesData.length + 1).toString(),
                Name: document.getElementById('roleName').value,
                Description: document.getElementById('roleDescription').value,
                IsActive: document.getElementById('roleActive').checked,
                CreatedDate: new Date().toISOString().split('T')[0]
            };

            // Simular guardado
            rolesData.push(formData);
            $('#RolesTableContainer').jtable('load');
            toggleCreatePanel();
            showNotification('Rol creado exitosamente', 'success');
        });

        // Abrir modal de edición
        function openEditModal(id) {
            const role = rolesData.find(r => r.Id === id);
            if (role) {
                document.getElementById('editRoleId').value = role.Id;
                document.getElementById('editRoleName').value = role.Name;
                document.getElementById('editRoleDescription').value = role.Description || '';
                document.getElementById('editRoleActive').checked = role.IsActive;

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            }
        }

        // Editar rol
        document.getElementById('editRoleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('editRoleId').value;
            const roleIndex = rolesData.findIndex(r => r.Id === id);

            if (roleIndex !== -1) {
                rolesData[roleIndex].Name = document.getElementById('editRoleName').value;
                rolesData[roleIndex].Description = document.getElementById('editRoleDescription').value;
                rolesData[roleIndex].IsActive = document.getElementById('editRoleActive').checked;

                $('#RolesTableContainer').jtable('load');
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                showNotification('Rol actualizado exitosamente', 'success');
            }
        });

        // Abrir modal de eliminación
        function openDeleteModal(id) {
            const role = rolesData.find(r => r.Id === id);
            if (role) {
                document.getElementById('deleteRoleId').value = role.Id;
                document.getElementById('deleteRoleName').textContent = role.Name;

                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                modal.show();
            }
        }

        // Eliminar rol
        function deleteRole() {
            const id = document.getElementById('deleteRoleId').value;
            const roleIndex = rolesData.findIndex(r => r.Id === id);

            if (roleIndex !== -1) {
                rolesData.splice(roleIndex, 1);
                $('#RolesTableContainer').jtable('load');
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                showNotification('Rol eliminado exitosamente', 'success');
            }
        }

        // Notificaciones
        function showNotification(message, type = 'success') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Validación en tiempo real
        document.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    </script>
</body>
</html>