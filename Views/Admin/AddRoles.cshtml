@model IEnumerable<RoleViewModel>

@{
    ViewData["Title"] = "Administración de Roles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">
            <i class="bi bi-shield-lock"></i> Administración de Roles
        </h2>
        <button class="btn btn-success shadow-sm" data-bs-toggle="collapse" data-bs-target="#newRolePanel" aria-expanded="false">
            <i class="bi bi-plus-circle"></i> Nuevo Rol
        </button>
    </div>

    <!-- Panel Crear Nuevo Rol este es el panel de creacion del rol aunq ue estamos utilizando puroJavaScript-->
    <div class="collapse mb-5" id="newRolePanel">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <form id="createRoleForm" asp-action="Create" asp-controller="Admin" method="post" novalidate>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="roleName" class="form-label fw-semibold">Nombre del Rol <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="roleName" name="Name"  required minlength="3" maxlength="50" placeholder="Ej. Administrador">
                            <div class="invalid-feedback">
                                El nombre del rol es requerido (mínimo 3 caracteres).
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="roleDescription" class="form-label fw-semibold">Descripción</label>
                            <textarea class="form-control" id="roleDescription" name="Description" rows="1" maxlength="200" placeholder="Describe brevemente la función del rol"></textarea>
                            <div class="invalid-feedback">
                                La descripción no puede exceder los 200 caracteres.
                            </div>
                        </div>

                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" id="roleActive" name="IsActive" checked>
                                <label class="form-check-label fw-semibold" for="roleActive">
                                    Rol Activo
                                </label>
                            </div>
                        </div>

                        <div class="col-12 text-end mt-3">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-floppy"></i> Guardar Rol
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de Roles -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-secondary">
                <i class="bi bi-list-check"></i> Roles Existentes
            </h5>
            <input type="text" class="form-control form-control-sm w-auto" id="searchInput" placeholder="Buscar rol...">
        </div>

        <div class="card-body p-0">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="rolesTable">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Estado</th>
                                <th>Fecha Creación</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var role in Model)
                            {
                                <tr>
                                    <td><strong>@role.Name</strong></td>
                                    <td>@(string.IsNullOrEmpty(role.Description) ? "-" : role.Description)</td>
                                    <td>
                                        <span class="badge rounded-pill @(role.IsActive ? "bg-success" : "bg-secondary")">
                                            @(role.IsActive ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>@role.CreatedDate.ToString("dd/MM/yyyy")</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" title="Editar"
                                                    data-bs-target="#editModal" data-bs-toggle="modal"
                                                    onclick="loadEditModal('@role.Id', '@role.Name', '@role.Description', @role.IsActive.ToString().ToLower())">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" title="Eliminar"
                                                    data-bs-target="#deleteModal" data-bs-toggle="modal"
                                                    onclick="loadDeleteModal('@role.Id', '@role.Name')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info m-3" role="alert">
                    <i class="bi bi-info-circle"></i> No hay roles registrados. Crea uno nuevo para comenzar.
                </div>
            }
        </div>
    </div>
</div>

<!-- Modales reutilizados -->
@await Html.PartialAsync("_EditRoleModal")
@await Html.PartialAsync("_DeleteRoleModal")

@section Scripts {
    <script>
        // Bootstrap tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

        // Filtro de búsqueda local
        document.getElementById("searchInput").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            document.querySelectorAll("#rolesTable tbody tr").forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        });

        // Validación de formularios con Bootstrap
        (() => {
            const forms = document.querySelectorAll('form[novalidate]');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);

                // Validación en tiempo real
                form.querySelectorAll('input, textarea').forEach(el => {
                    el.addEventListener('input', () => {
                        if (el.checkValidity()) {
                            el.classList.add('is-valid');
                            el.classList.remove('is-invalid');
                        } else {
                            el.classList.add('is-invalid');
                            el.classList.remove('is-valid');
                        }
                    });
                });
            });
        })();

        // Cargar datos al modal de edición
        function loadEditModal(id, name, description, isActive) {
            document.getElementById('editRoleId').value = id;
            document.getElementById('editRoleName').value = name;
            document.getElementById('editRoleDescription').value = description || '';
            document.getElementById('editRoleActive').checked = isActive;
        }

        // Cargar datos al modal de eliminación
        function loadDeleteModal(id, name) {
            document.getElementById('deleteRoleId').value = id;
            document.getElementById('deleteRoleName').textContent = name;
        }
    </script>
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
<link href="~/css/validation-site.css" rel="stylesheet" />

